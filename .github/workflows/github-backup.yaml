name: Backup to AWS S3
on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch: # Allow manual triggering from GitHub Actions UI
jobs:
  backup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for complete backup
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.S3_GITHUB_BACKUP_USER_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.S3_GITHUB_BACKUP_USER_SECRET_KEY }}
          aws-region: ap-southeast-2
      
      - name: Create git bundle and upload to S3
        run: |
          # Create timestamped backup filename
          TIMESTAMP=$(date +%Y-%m-%d_%H-%M-%S)
          REPO_NAME="${{ github.repository }}"
          # Replace / with - for S3 path
          REPO_PATH="${REPO_NAME//\//-}"
          BUNDLE_FILE="${REPO_PATH}_${TIMESTAMP}.bundle"
          
          # Create a complete git bundle (includes all branches, tags, and history)
          git bundle create "${BUNDLE_FILE}" --all
          
          # Upload timestamped bundle to S3
          aws s3 cp "${BUNDLE_FILE}" "s3://recovery-github-backups/${REPO_PATH}/${TIMESTAMP}/${BUNDLE_FILE}"
          
          # Also upload as 'latest' for easy access
          aws s3 cp "${BUNDLE_FILE}" "s3://recovery-github-backups/${REPO_PATH}/latest/${REPO_PATH}_latest.bundle"
          
          # Clean up local bundle file
          rm "${BUNDLE_FILE}"
